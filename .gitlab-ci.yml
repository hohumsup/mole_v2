stages:
  - test

variables:
  POSTGRES_USER: mole_user
  POSTGRES_PASSWORD: secret
  POSTGRES_DB: mole
  GO_VERSION: "1.23.5"

services:
  - name: postgis/postgis:16-3.5
    alias: postgres

before_script:
  - apt-get update && apt-get install -y curl
  - curl -L https://github.com/golang-migrate/migrate/releases/download/v4.18.1/migrate.linux-amd64.tar.gz | tar xvz
  - mv migrate /usr/local/bin/migrate
  - which migrate
  - echo "Setting up Go..."
  - apt-get install -y golang-${GO_VERSION}
  - export PATH="/usr/lib/go-${GO_VERSION}/bin:$PATH"
  - go version
  - make migrateup

test:
  stage: test
  image: golang:${GO_VERSION}
  script:
    - make test
